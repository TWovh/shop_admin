{% extends "admin/base_site.html" %}

{% block content %}
  <h1>Оформление заказа</h1>

  <h3>1. Доставка</h3>
  <label>Город:</label><br>
  <input type="text" id="city" placeholder="Введите город...">
  <ul id="city-suggestions" style="border:1px solid #ccc; display:none; max-height:150px; overflow-y:auto;"></ul>

  <br><br>
  <label>Отделение НП:</label><br>
  <select id="warehouse">
    <option selected disabled>Оберіть спочатку місто</option>
  </select>

  <hr>

  <h3>2. Платёжная система</h3>
  <label><input type="radio" name="payment_method" value="stripe" checked> Stripe</label><br>
  <label><input type="radio" name="payment_method" value="paypal"> PayPal</label><br>
  <label><input type="radio" name="payment_method" value="fondy"> Fondy</label><br>
  <label><input type="radio" name="payment_method" value="liqpay"> LiqPay</label><br>

  <hr>

  <h3>3. Итого к оплате: <span id="order-total">{{ cart_total }} грн</span></h3>

  <button type="submit">Перейти к оплате</button>

  <script>
    const cityInput = document.getElementById("city");
    const citySuggestions = document.getElementById("city-suggestions");
    const warehouseSelect = document.getElementById("warehouse");

    let cities = [];

    cityInput.addEventListener("input", () => {
      const query = cityInput.value.trim();
      if (query.length < 3) {
        citySuggestions.style.display = "none";
        return;
      }

      fetch(`/api/np/cities/?search=${query}`)
        .then(res => res.json())
        .then(data => {
          citySuggestions.innerHTML = "";
          cities = data.data || [];

          cities.forEach(city => {
            const li = document.createElement("li");
            li.textContent = city.Description;
            li.style.cursor = "pointer";
            li.addEventListener("click", () => selectCity(city));
            citySuggestions.appendChild(li);
          });

          citySuggestions.style.display = "block";
        });
    });

    function selectCity(city) {
      cityInput.value = city.Description;
      citySuggestions.style.display = "none";
      loadWarehouses(city.Ref);
    }

    function loadWarehouses(cityRef) {
      warehouseSelect.innerHTML = '<option>Завантаження...</option>';
      fetch(`/api/np/warehouses/?city_ref=${cityRef}`)
        .then(res => res.json())
        .then(data => {
          const warehouses = data.data || [];
          warehouseSelect.innerHTML = "";

          warehouses.forEach(wh => {
            const option = document.createElement("option");
            option.value = wh.Ref;
            option.textContent = wh.Description;
            warehouseSelect.appendChild(option);
          });
        });
    }
  </script>
{% endblock %}
