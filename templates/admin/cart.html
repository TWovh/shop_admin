{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <h1>Ваша корзина</h1>

  <div id="cart-content">
    <p>Загрузка корзины...</p>
  </div>
</div>

<script>
async function loadCart() {
  try {
    const response = await fetch('/api/cart/', {
      headers: { 'Accept': 'application/json' },
      credentials: 'include'  // чтобы сессионные куки отправлялись
    });

    if (response.status === 401) {
      document.getElementById('cart-content').innerHTML = `
        <p>Пожалуйста, <a href="/login/">войдите</a>, чтобы видеть корзину.</p>
      `;
      return;
    }

    if (!response.ok) {
      document.getElementById('cart-content').innerHTML = '<p>Ошибка загрузки корзины.</p>';
      return;
    }

    const data = await response.json();

    if (data.items.length === 0) {
      document.getElementById('cart-content').innerHTML = '<p>Ваша корзина пуста.</p>';
      return;
    }

    let html = `
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Товар</th>
            <th>Количество</th>
            <th>Сумма</th>
          </tr>
        </thead>
        <tbody>
    `;

    data.items.forEach(item => {
      html += `
        <tr>
          <td>${item.product}</td>
          <td>${item.quantity}</td>
          <td>${item.total_price} ₽</td>
        </tr>
      `;
    });

    html += `
        </tbody>
        <tfoot>
          <tr>
            <th colspan="2">Итого</th>
            <th>${data.total_price} ₽</th>
          </tr>
        </tfoot>
      </table>
    `;

    document.getElementById('cart-content').innerHTML = html;

  } catch (error) {
    document.getElementById('cart-content').innerHTML = '<p>Ошибка загрузки корзины.</p>';
    console.error('Cart load error:', error);
  }
}

document.addEventListener('DOMContentLoaded', loadCart);
</script>
{% endblock %}
